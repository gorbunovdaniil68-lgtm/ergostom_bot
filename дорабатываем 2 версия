# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
!pip install python-telegram-bot==20.7

# –ü–û–õ–ù–´–ô –ö–û–î –ë–û–¢–ê –°–ö–õ–ê–î–°–¢–û–ú - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import asyncio
import logging
import sqlite3
import secrets
import re
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
TOKEN = ""  # <-- –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –¢–û–ö–ï–ù!

# ========== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ==========
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• ==========
def init_database():
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    
    # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS clinics (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        code TEXT UNIQUE NOT NULL,
        admin_chat_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS clinic_users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        clinic_id INTEGER,
        chat_id INTEGER,
        username TEXT,
        first_name TEXT,
        role TEXT DEFAULT 'user',
        FOREIGN KEY (clinic_id) REFERENCES clinics (id),
        UNIQUE(clinic_id, chat_id)
    )
    ''')
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS warehouse (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        clinic_id INTEGER NOT NULL,
        category TEXT NOT NULL,
        name TEXT NOT NULL,
        quantity INTEGER DEFAULT 0,
        min_quantity INTEGER DEFAULT 1,
        FOREIGN KEY (clinic_id) REFERENCES clinics (id),
        UNIQUE(clinic_id, name)
    )
    ''')
    
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS history (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        clinic_id INTEGER,
        item_id INTEGER,
        operation TEXT,
        quantity INTEGER,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (clinic_id) REFERENCES clinics (id),
        FOREIGN KEY (item_id) REFERENCES warehouse (id)
    )
    ''')
    
    # –ò–ù–î–ï–ö–°–´ –î–õ–Ø –ë–´–°–¢–†–û–ì–û –ü–û–ò–°–ö–ê
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_warehouse_clinic_name ON warehouse(clinic_id, name)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_warehouse_lower_name ON warehouse(LOWER(name))')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_clinic_users_chat ON clinic_users(chat_id)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_history_clinic_time ON history(clinic_id, timestamp)')
    
    # –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫ (–¥–æ–±–∞–≤–∏–ª–∏)
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS error_logs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        error_text TEXT,
        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    conn.commit()
    conn.close()

init_database()
print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞! –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã.")

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
def clean_input(text, max_length=100):
    """–û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤"""
    if not text:
        return ""
    
    # –£–¥–∞–ª—è–µ–º –æ–ø–∞—Å–Ω—ã–µ SQL —Å–∏–º–≤–æ–ª—ã
    dangerous = [";", "'", "\"", "--", "/*", "*/", "\\", "\x00", "\n", "\r", "\t"]
    clean_text = text
    for danger in dangerous:
        clean_text = clean_text.replace(danger, "")
    
    # –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
    clean_text = re.sub(r'<[^>]+>', '', clean_text)
    
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    clean_text = re.sub(r'[^\w\s\-.,!?()–∞-—è–ê-–Ø—ë–Å]', '', clean_text)
    
    return clean_text.strip()[:max_length]

def generate_code():
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–æ–¥–∞ –¥–ª—è –∫–ª–∏–Ω–∏–∫–∏"""
    return secrets.token_hex(3).upper()

def get_user_clinic(chat_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–Ω–∏–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT c.id, c.name, c.code, cu.role 
        FROM clinic_users cu
        JOIN clinics c ON cu.clinic_id = c.id
        WHERE cu.chat_id = ?
    ''', (chat_id,))
    clinic = cursor.fetchone()
    conn.close()
    return clinic

def get_clinic_items(clinic_id, category='all'):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∫–ª–∏–Ω–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    
    if category == 'all':
        cursor.execute('''
            SELECT id, name, quantity, min_quantity, category 
            FROM warehouse 
            WHERE clinic_id = ? 
            ORDER BY category, name
        ''', (clinic_id,))
    else:
        cursor.execute('''
            SELECT id, name, quantity, min_quantity, category 
            FROM warehouse 
            WHERE clinic_id = ? AND category = ?
            ORDER BY name
        ''', (clinic_id, category))
    
    items = cursor.fetchall()
    conn.close()
    return items

def search_items(clinic_id, search_query):
    """–ë–ï–ó–û–ü–ê–°–ù–´–ô –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é"""
    if not search_query:
        return []
    
    # –û—á–∏—â–∞–µ–º –∑–∞–ø—Ä–æ—Å
    clean_query = clean_input(search_query, max_length=50).lower().strip()
    
    if len(clean_query) < 2:
        return []
    
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    
    # –ë–ï–ó–û–ü–ê–°–ù–´–ô –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    cursor.execute('''
        SELECT id, name, quantity, min_quantity, category 
        FROM warehouse 
        WHERE clinic_id = ? 
        AND LOWER(name) LIKE '%' || LOWER(?) || '%'
        ORDER BY 
            CASE 
                WHEN LOWER(name) LIKE LOWER(?) || '%' THEN 1
                WHEN LOWER(name) LIKE '% ' || LOWER(?) || '%' THEN 2
                ELSE 3
            END,
            name
        LIMIT 20
    ''', (clinic_id, clean_query, clean_query, clean_query))
    
    items = cursor.fetchall()
    conn.close()
    return items

def update_item_quantity(item_id, change, operation, clinic_id):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ —Å –∑–∞–ø–∏—Å—å—é –≤ –∏—Å—Ç–æ—Ä–∏—é"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    
    try:
        # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        cursor.execute('BEGIN TRANSACTION')
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        cursor.execute('UPDATE warehouse SET quantity = quantity + ? WHERE id = ?', (change, item_id))
        
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        cursor.execute('''
            INSERT INTO history (clinic_id, item_id, operation, quantity)
            VALUES (?, ?, ?, ?)
        ''', (clinic_id, item_id, operation, change))
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        cursor.execute('SELECT name, quantity FROM warehouse WHERE id = ?', (item_id,))
        result = cursor.fetchone()
        
        # –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        conn.commit()
        
        return result
        
    except Exception as e:
        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
        conn.rollback()
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ {item_id}: {e}")
        return None
    finally:
        conn.close()

def get_items_to_order(clinic_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ (–Ω–∏–∂–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø–∞—Å–∞)"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT name, quantity, min_quantity 
        FROM warehouse 
        WHERE clinic_id = ? AND quantity <= min_quantity
        ORDER BY quantity ASC
    ''', (clinic_id,))
    items = cursor.fetchall()
    conn.close()
    return items

def get_clinic_users(clinic_id):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫–ª–∏–Ω–∏–∫–∏"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT first_name, username, role 
        FROM clinic_users 
        WHERE clinic_id = ?
    ''', (clinic_id,))
    users = cursor.fetchall()
    conn.close()
    return users

def log_error_to_db(user_id, error_text):
    """–ó–∞–ø–∏—Å—å –æ—à–∏–±–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"""
    try:
        conn = sqlite3.connect('sklad_complete.db')
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO error_logs (user_id, error_text)
            VALUES (?, ?)
        ''', (user_id, error_text[:500]))
        conn.commit()
        conn.close()
    except:
        pass  # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –æ—à–∏–±–∫—É - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def get_main_keyboard(has_clinic=False, is_admin=False):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã"""
    if not has_clinic:
        return ReplyKeyboardMarkup([
            ['üè• –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–Ω–∏–∫—É'],
            ['üîë –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏']
        ], resize_keyboard=True)
    
    if is_admin:
        return ReplyKeyboardMarkup([
            ['üì¶ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∫–ª–∞–¥', 'üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞'],
            ['‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª', '‚ûñ –°–ø–∏—Å–∞—Ç—å'],
            ['üõí –ß—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å?', 'üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'],
            ['üî¢ –ú–æ–π –∫–æ–¥', 'üè• –ò–Ω—Ñ–æ –æ –∫–ª–∏–Ω–∏–∫–µ'],
            ['üö™ –í—ã–π—Ç–∏']
        ], resize_keyboard=True)
    else:
        return ReplyKeyboardMarkup([
            ['üì¶ –ù–∞—à —Å–∫–ª–∞–¥', 'üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞'],
            ['‚ûñ –°–ø–∏—Å–∞—Ç—å', 'üõí –ß—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å?'],
            ['üè• –ù–∞—à–∞ –∫–ª–∏–Ω–∏–∫–∞', 'üö™ –í—ã–π—Ç–∏']
        ], resize_keyboard=True)

def get_categories_keyboard(clinic_id, action='view'):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
    if action == 'remove':
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("ü¶∑ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã", callback_data=f'remove_cat_–ú–∞—Ç–µ—Ä–∏–∞–ª—ã_{clinic_id}')],
            [InlineKeyboardButton("üß¥ –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", callback_data=f'remove_cat_–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏_{clinic_id}')],
            [InlineKeyboardButton("üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", callback_data=f'remove_cat_–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã_{clinic_id}')],
            [InlineKeyboardButton("üìã –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data=f'remove_cat_all_{clinic_id}')]
        ])
    else:
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("ü¶∑ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã", callback_data=f'cat_–ú–∞—Ç–µ—Ä–∏–∞–ª—ã_{clinic_id}')],
            [InlineKeyboardButton("üß¥ –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏", callback_data=f'cat_–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏_{clinic_id}')],
            [InlineKeyboardButton("üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã", callback_data=f'cat_–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã_{clinic_id}')],
            [InlineKeyboardButton("üìã –í—Å—ë —Å—Ä–∞–∑—É", callback_data=f'cat_all_{clinic_id}')]
        ])

# ========== –î–ï–ö–û–†–ê–¢–û–† –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö ==========
def safe_handler(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"""
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        try:
            return await func(update, context)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤ {func.__name__}: {e}", exc_info=True)
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –ë–î
            if update and update.effective_chat:
                log_error_to_db(update.effective_chat.id, str(e))
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if update and update.message:
                await update.message.reply_text(
                    "‚ö†Ô∏è *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ /start\n"
                    "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    parse_mode='Markdown'
                )
    return wrapper

# ========== –ö–û–ú–ê–ù–î–´ ==========
@safe_handler
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if clinic:
        clinic_id, name, code, role = clinic
        await update.message.reply_text(
            f"üè• *{name}*\n"
            f"–í–∞—à–∞ —Ä–æ–ª—å: *{role}*\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=get_main_keyboard(True, role == 'admin'),
            parse_mode='Markdown'
        )
    else:
        await update.message.reply_text(
            "üì¶ *–°–∫–ª–∞–¥–°—Ç–æ–º –¥–ª—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–π*\n\n"
            "–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–Ω–∏–∫–æ–≤.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=get_main_keyboard(False, False),
            parse_mode='Markdown'
        )

@safe_handler
async def leave_clinic(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    
    try:
        cursor.execute('BEGIN TRANSACTION')
        
        cursor.execute('''
            SELECT c.id, c.name, cu.role 
            FROM clinic_users cu
            JOIN clinics c ON cu.clinic_id = c.id
            WHERE cu.chat_id = ?
        ''', (chat_id,))
        
        clinic_info = cursor.fetchone()
        
        if not clinic_info:
            await update.message.reply_text("‚ùå –í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –Ω–∏ –≤ –æ–¥–Ω–æ–π –∫–ª–∏–Ω–∏–∫–µ!")
            conn.close()
            return
        
        clinic_id, clinic_name, role = clinic_info
        
        # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–ª–∏–Ω–∏–∫–∏
        cursor.execute('DELETE FROM clinic_users WHERE chat_id = ?', (chat_id,))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        cursor.execute('SELECT COUNT(*) FROM clinic_users WHERE clinic_id = ?', (clinic_id,))
        remaining_users = cursor.fetchone()[0]
        
        if role == 'admin' and remaining_users == 0:
            # –ï—Å–ª–∏ –∫–ª–∏–Ω–∏–∫—É —Å–æ–∑–¥–∞–ª –∞–¥–º–∏–Ω –∏ –æ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π - —É–¥–∞–ª—è–µ–º –≤—Å—ë
            cursor.execute('DELETE FROM clinics WHERE id = ?', (clinic_id,))
            cursor.execute('DELETE FROM warehouse WHERE clinic_id = ?', (clinic_id,))
            cursor.execute('DELETE FROM history WHERE clinic_id = ?', (clinic_id,))
            message = f"üóëÔ∏è –ö–ª–∏–Ω–∏–∫–∞ *{clinic_name}* –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞."
        else:
            message = f"üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ –∫–ª–∏–Ω–∏–∫–∏ *{clinic_name}*"
        
        conn.commit()
        
    except Exception as e:
        conn.rollback()
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–ª–∏–Ω–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        logger.error(f"–û—à–∏–±–∫–∞ –≤ leave_clinic: {e}")
    finally:
        conn.close()
    
    await update.message.reply_text(
        f"{message}\n\n"
        f"–¢–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç–µ:\n"
        f"‚Ä¢ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–ª–∏–Ω–∏–∫—É\n"
        f"‚Ä¢ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥–æ–π",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup([
            ['üè• –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–Ω–∏–∫—É'],
            ['üîë –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏']
        ], resize_keyboard=True)
    )

# ========== –§–£–ù–ö–¶–ò–ò –°–ö–õ–ê–î–ê ==========
@safe_handler
async def show_warehouse(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    await update.message.reply_text(
        f"üè• *{name}*\nüìÇ –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=get_categories_keyboard(clinic_id, 'view'),
        parse_mode='Markdown'
    )

@safe_handler
async def handle_category(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    category = data[1]
    clinic_id = int(data[2])
    
    items = get_clinic_items(clinic_id, category)
    
    if category == 'all':
        title = "üì¶ *–í–ï–°–¨ –°–ö–õ–ê–î:*\n\n"
    else:
        title = f"üìÇ *{category.upper()}:*\n\n"
    
    if not items:
        message = title + "–ü—É—Å—Ç–æ"
    else:
        message = title
        for item in items:
            item_id, name, quantity, min_qty, item_category = item
            status = "üü°" if quantity <= min_qty else "üü¢"
            message += f"{status} *{name}*\n–û—Å—Ç–∞—Ç–æ–∫: {quantity} —à—Ç. (–º–∏–Ω: {min_qty})\n\n"
    
    await query.edit_message_text(message, parse_mode='Markdown')

@safe_handler
async def remove_item_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    await update.message.reply_text(
        "‚ûñ *–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:*",
        reply_markup=get_categories_keyboard(clinic_id, 'remove'),
        parse_mode='Markdown'
    )

@safe_handler
async def handle_remove_category(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    category = data[2]
    clinic_id = int(data[3])
    
    items = get_clinic_items(clinic_id, category)
    
    if not items:
        await query.edit_message_text("‚ùå –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤!")
        return
    
    keyboard = []
    for item in items[:15]:
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: item —Å–æ–¥–µ—Ä–∂–∏—Ç 5 –∑–Ω–∞—á–µ–Ω–∏–π, –∞ –Ω–µ 4
        item_id, name, quantity, min_qty, item_category = item
        keyboard.append([InlineKeyboardButton(f"‚ûñ {name} ({quantity} —à—Ç.)", callback_data=f'do_remove_{item_id}_{clinic_id}')])
    
    await query.edit_message_text(
        "‚ûñ *–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:*\n(—Å–ø–∏—à–µ—Ç—Å—è 1 –µ–¥–∏–Ω–∏—Ü–∞)",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

@safe_handler
async def execute_remove(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    item_id = int(data[2])
    clinic_id = int(data[3])
    
    result = update_item_quantity(item_id, -1, '—Å–ø–∏—Å–∞–Ω–∏–µ', clinic_id)
    
    if result:
        name, new_quantity = result
        message = f"‚úÖ *–°–ø–∏—Å–∞–Ω–æ!*\n\n*{name}*\n–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫: *{new_quantity} —à—Ç.*"
        
        conn = sqlite3.connect('sklad_complete.db')
        cursor = conn.cursor()
        cursor.execute('SELECT min_quantity FROM warehouse WHERE id = ?', (item_id,))
        min_qty = cursor.fetchone()[0]
        conn.close()
        
        if new_quantity <= min_qty:
            message += f"\n\nüü° *–í–Ω–∏–º–∞–Ω–∏–µ!* –ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å {name}!"
    
    await query.edit_message_text(message, parse_mode='Markdown')

@safe_handler
async def show_to_order(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    items = get_items_to_order(clinic_id)
    
    if not items:
        message = f"üè• *{name}*\n‚úÖ –í—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –Ω–æ—Ä–º–µ! –ó–∞–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ."
    else:
        message = f"üè• *{name}*\nüõí *–ü–û–ó–ò–¶–ò–ò –î–õ–Ø –ó–ê–ö–ê–ó–ê:*\n\n"
        for item in items:
            item_name, quantity, min_qty = item
            message += f"üü° *{item_name}*\n–û—Å—Ç–∞–ª–æ—Å—å: {quantity} –∏–∑ {min_qty} –º–∏–Ω.\n\n"
    
    await update.message.reply_text(message, parse_mode='Markdown')

@safe_handler
async def add_item_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    
    if role != 'admin':
        await update.message.reply_text("‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã!")
        return
    
    await update.message.reply_text(
        "‚ûï *–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`–ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ú–∏–Ω.–∑–∞–ø–∞—Å`\n\n"
        "*–ü—Ä–∏–º–µ—Ä:*\n"
        "`–ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –ë–æ–Ω–¥, 10, 3`\n\n"
        "*–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:* –ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏, –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã\n\n"
        "‚ùå *–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–∏—à–∏—Ç–µ /cancel*",
        parse_mode='Markdown'
    )
    context.user_data['adding_item'] = True
    context.user_data['clinic_id'] = clinic_id

@safe_handler
async def show_clinic_users(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    
    if role != 'admin':
        await update.message.reply_text("‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!")
        return
    
    users = get_clinic_users(clinic_id)
    
    message = f"üë• *–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ {name}:*\n\n"
    
    for user in users:
        first_name, username, user_role = user
        username_display = f"(@{username})" if username else ""
        message += f"‚Ä¢ {first_name} {username_display} - {user_role}\n"
    
    message += f"\n–í—Å–µ–≥–æ: {len(users)} —á–µ–ª–æ–≤–µ–∫\n\n"
    message += f"üî¢ –ö–æ–¥ –∫–ª–∏–Ω–∏–∫–∏: `{code}`"
    
    await update.message.reply_text(message, parse_mode='Markdown')

@safe_handler
async def show_clinic_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    users = get_clinic_users(clinic_id)
    
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('SELECT COUNT(*) FROM warehouse WHERE clinic_id = ?', (clinic_id,))
    items_count = cursor.fetchone()[0]
    conn.close()
    
    message = (
        f"üè• *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–Ω–∏–∫–µ:*\n\n"
        f"‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: {name}\n"
        f"‚Ä¢ –°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {len(users)}\n"
        f"‚Ä¢ –ú–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: {items_count}\n"
        f"‚Ä¢ –í–∞—à–∞ —Ä–æ–ª—å: {role}\n"
    )
    
    if role == 'admin':
        message += f"‚Ä¢ –ö–æ–¥ –∫–ª–∏–Ω–∏–∫–∏: `{code}`\n\n"
        message += "*–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:*\n"
        message += "1. –î–∞–π—Ç–µ –∏–º –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏\n"
        message += "2. –û–Ω–∏ –ø–∏—à—É—Ç /start > '–í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏'\n"
        message += "3. –í–≤–æ–¥—è—Ç –∫–æ–¥"
    
    await update.message.reply_text(message, parse_mode='Markdown')

# ========== –§–£–ù–ö–¶–ò–ò –ü–û–ò–°–ö–ê ==========
@safe_handler
async def search_items_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    clinic = get_user_clinic(chat_id)
    
    if not clinic:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–ª–∏–Ω–∏–∫–µ!")
        return
    
    clinic_id, name, code, role = clinic
    
    await update.message.reply_text(
        f"üîç *–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤*\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è:\n\n"
        f"*–ü—Ä–∏–º–µ—Ä—ã:*\n"
        f"‚Ä¢ `–ø–µ—Ä—á–∞—Ç–∫–∏` - –Ω–∞–π–¥–µ—Ç –≤—Å–µ –ø–µ—Ä—á–∞—Ç–∫–∏\n"
        f"‚Ä¢ `–±–æ–Ω–¥` - –Ω–∞–π–¥–µ—Ç –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å '–±–æ–Ω–¥'\n"
        f"‚Ä¢ `spectra` - –Ω–∞–π–¥–µ—Ç Spectra A2\n\n"
        f"–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é.\n"
        f"‚ùå *–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–∏—à–∏—Ç–µ /cancel*",
        parse_mode='Markdown'
    )
    
    context.user_data['searching'] = True
    context.user_data['clinic_id'] = clinic_id

@safe_handler
async def handle_search_item(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø–æ–∏—Å–∫–∞"""
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    item_id = int(data[2])
    clinic_id = int(data[3])
    
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('''
        SELECT name, quantity, min_quantity, category 
        FROM warehouse 
        WHERE id = ?
    ''', (item_id,))
    
    item = cursor.fetchone()
    conn.close()
    
    if not item:
        await query.edit_message_text("‚ùå –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    
    name, quantity, min_qty, category = item
    status = "üü° –¢–†–ï–ë–£–ï–¢ –ó–ê–ö–ê–ó–ê" if quantity <= min_qty else "üü¢ –í –ù–û–†–ú–ï"
    
    message = (
        f"üìã *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ:*\n\n"
        f"*{name}*\n"
        f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}\n"
        f"–û—Å—Ç–∞—Ç–æ–∫: {quantity} —à—Ç.\n"
        f"–ú–∏–Ω. –∑–∞–ø–∞—Å: {min_qty} —à—Ç.\n"
        f"–°—Ç–∞—Ç—É—Å: {status}\n\n"
        f"–î–µ–π—Å—Ç–≤–∏—è —Å —Ç–æ–≤–∞—Ä–æ–º:"
    )
    
    keyboard = [
        [InlineKeyboardButton("‚ûñ –°–ø–∏—Å–∞—Ç—å 1 —à—Ç.", callback_data=f'remove_from_search_{item_id}_{clinic_id}')],
        [InlineKeyboardButton("üîç –ò—Å–∫–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data=f'new_search_{clinic_id}')],
        [InlineKeyboardButton("üì¶ –í–µ—Å—å —Å–∫–ª–∞–¥", callback_data=f'cat_all_{clinic_id}')],
        [InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data=f'back_menu_{clinic_id}')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

@safe_handler
async def remove_from_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞"""
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    item_id = int(data[3])
    clinic_id = int(data[4])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    chat_id = query.from_user.id
    clinic_info = get_user_clinic(chat_id)
    
    if not clinic_info or clinic_info[0] != clinic_id:
        await query.edit_message_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è!")
        return
    
    result = update_item_quantity(item_id, -1, '—Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫', clinic_id)
    
    if result:
        name, new_quantity = result
        message = f"‚úÖ *–°–ø–∏—Å–∞–Ω–æ –∏–∑ –ø–æ–∏—Å–∫–∞!*\n\n*{name}*\n–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫: *{new_quantity} —à—Ç.*"
        
        conn = sqlite3.connect('sklad_complete.db')
        cursor = conn.cursor()
        cursor.execute('SELECT min_quantity FROM warehouse WHERE id = ?', (item_id,))
        min_qty = cursor.fetchone()[0]
        conn.close()
        
        if new_quantity <= min_qty:
            message += f"\n\nüü° *–í–Ω–∏–º–∞–Ω–∏–µ!* –ù—É–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å {name}!"
        
        keyboard = [
            [InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data=f'new_search_{clinic_id}')],
            [InlineKeyboardButton("üì¶ –í–µ—Å—å —Å–∫–ª–∞–¥", callback_data=f'cat_all_{clinic_id}')],
            [InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data=f'back_menu_{clinic_id}')]
        ]
        
        await query.edit_message_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='Markdown'
        )

@safe_handler
async def handle_search_navigation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –ø–æ–∏—Å–∫–µ"""
    query = update.callback_query
    await query.answer()
    
    data = query.data.split('_')
    action = data[0]
    
    if action == 'new':
        clinic_id = int(data[2])
        await search_items_start_callback(query, clinic_id)
    elif action == 'back':
        clinic_id = int(data[2])
        await show_main_menu_from_callback(query, clinic_id)

async def search_items_start_callback(query, clinic_id):
    """–ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –∏–∑ callback"""
    await query.edit_message_text(
        "üîç *–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:*",
        parse_mode='Markdown'
    )

async def show_main_menu_from_callback(query, clinic_id):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–∑ callback"""
    conn = sqlite3.connect('sklad_complete.db')
    cursor = conn.cursor()
    cursor.execute('SELECT name FROM clinics WHERE id = ?', (clinic_id,))
    clinic_name = cursor.fetchone()[0]
    conn.close()
    
    await query.edit_message_text(
        f"üè• *{clinic_name}*\n–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
        parse_mode='Markdown'
    )

# ========== –ö–û–ú–ê–ù–î–ê –û–¢–ú–ï–ù–´ ==========
@safe_handler
async def cancel_operation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"""
    chat_id = update.effective_chat.id
    
    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
    if 'searching' in context.user_data:
        del context.user_data['searching']
    if 'adding_item' in context.user_data:
        del context.user_data['adding_item']
    if 'creating_clinic' in context.user_data:
        del context.user_data['creating_clinic']
    if 'joining_clinic' in context.user_data:
        del context.user_data['joining_clinic']
    
    clinic = get_user_clinic(chat_id)
    has_clinic = bool(clinic)
    is_admin = clinic[3] == 'admin' if clinic else False
    
    await update.message.reply_text(
        "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_keyboard(has_clinic, is_admin)
    )

# ========== –¢–ï–ö–°–¢–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
@safe_handler
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    chat_id = update.effective_chat.id
    
    if not text:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—É –æ—Ç–º–µ–Ω—ã
    if text.lower() == '/cancel':
        await cancel_operation(update, context)
        return
    
    if context.user_data.get('searching'):
        search_query = clean_input(text, max_length=50)
        
        if len(search_query) < 2:
            await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞!")
            return
        
        clinic_id = context.user_data['clinic_id']
        
        found_items = search_items(clinic_id, search_query)
        
        if not found_items:
            message = (
                f"üîç *–ü–æ –∑–∞–ø—Ä–æ—Å—É '{search_query}' –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ*\n\n"
                f"*–°–æ–≤–µ—Ç—ã:*\n"
                f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø–µ—á–∞—Ç–∫–∏\n"
                f"‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å\n"
                f"‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–∞—Å—Ç—å —Å–ª–æ–≤–∞: '–ø–µ—Ä—á' –≤–º–µ—Å—Ç–æ '–ø–µ—Ä—á–∞—Ç–∫–∏'\n\n"
                f"–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞?"
            )
            
            keyboard = [
                [InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data=f'new_search_{clinic_id}')],
                [InlineKeyboardButton("üì¶ –í–µ—Å—å —Å–∫–ª–∞–¥", callback_data=f'cat_all_{clinic_id}')],
                [InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data=f'back_menu_{clinic_id}')]
            ]
            
            await update.message.reply_text(
                message,
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='Markdown'
            )
        else:
            items_count = len(found_items)
            message = f"üîç *–ù–∞–π–¥–µ–Ω–æ {items_count} —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_query}':*\n\n"
            
            keyboard = []
            for item in found_items[:15]:
                item_id, name, quantity, min_qty, category = item
                
                status = "üü°" if quantity <= min_qty else "üü¢"
                message += f"{status} *{name}* ({category})\n"
                message += f"–û—Å—Ç–∞—Ç–æ–∫: {quantity} —à—Ç.\n\n"
                short_name = name[:25] + "..." if len(name) > 25 else name
                button_text = f"{status} {short_name} ({quantity} —à—Ç.)"
                keyboard.append([InlineKeyboardButton(button_text, callback_data=f'search_item_{item_id}_{clinic_id}')])
            
            if items_count > 15:
                message += f"\n... –∏ –µ—â—ë {items_count - 15} —Ç–æ–≤–∞—Ä–æ–≤"
            
            keyboard.append([InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data=f'new_search_{clinic_id}')])
            keyboard.append([InlineKeyboardButton("üì¶ –í–µ—Å—å —Å–∫–ª–∞–¥", callback_data=f'cat_all_{clinic_id}')])
            keyboard.append([InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data=f'back_menu_{clinic_id}')])
            
            await update.message.reply_text(
                message,
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='Markdown'
            )
        
        context.user_data['searching'] = False
        return
    
    if context.user_data.get('adding_item'):
        try:
            parts = [p.strip() for p in text.split(',')]
            if len(parts) != 4:
                raise ValueError
            
            category = clean_input(parts[0])
            name = clean_input(parts[1])
            quantity_str = parts[2].strip()
            min_qty_str = parts[3].strip()
            
            category = category.capitalize()
            if category not in ['–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã']:
                await update.message.reply_text("‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å: –ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏ –∏–ª–∏ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã")
                return
            
            try:
                quantity = int(quantity_str)
                min_quantity = int(min_qty_str)
                
                if quantity < 0 or min_quantity < 0:
                    await update.message.reply_text("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º!")
                    return
                
                if quantity > 10000 or min_quantity > 1000:
                    await update.message.reply_text("‚ùå –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ! –ú–∞–∫—Å: 10,000")
                    return
                    
            except ValueError:
                await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–∞ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ –º–∏–Ω.–∑–∞–ø–∞—Å–∞!")
                return
            
            clinic_id = context.user_data['clinic_id']
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            conn = sqlite3.connect('sklad_complete.db')
            cursor = conn.cursor()
            cursor.execute('''
                SELECT id FROM warehouse 
                WHERE clinic_id = ? AND LOWER(name) = LOWER(?)
            ''', (clinic_id, name))
            
            if cursor.fetchone():
                await update.message.reply_text(f"‚ùå –¢–æ–≤–∞—Ä '{name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
                conn.close()
                return
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
            cursor.execute('''
                INSERT INTO warehouse (clinic_id, category, name, quantity, min_quantity)
                VALUES (?, ?, ?, ?, ?)
            ''', (clinic_id, category, name, quantity, min_quantity))
            
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            item_id = cursor.lastrowid
            cursor.execute('''
                INSERT INTO history (clinic_id, item_id, operation, quantity)
                VALUES (?, ?, ?, ?)
            ''', (clinic_id, item_id, '–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ', quantity))
            
            conn.commit()
            conn.close()
            
            await update.message.reply_text(
                f"‚úÖ *–î–æ–±–∞–≤–ª–µ–Ω–æ!*\n\n"
                f"*{name}*\n"
                f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}\n"
                f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity} —à—Ç.\n"
                f"–ú–∏–Ω.–∑–∞–ø–∞—Å: {min_quantity} —à—Ç.",
                parse_mode='Markdown'
            )
            
        except ValueError:
            await update.message.reply_text(
                "‚ùå *–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!*\n\n"
                "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `–ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∑–≤–∞–Ω–∏–µ, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ú–∏–Ω.–∑–∞–ø–∞—Å`\n\n"
                "*–ü—Ä–∏–º–µ—Ä:*\n`–ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –ë–æ–Ω–¥, 10, 3`\n\n"
                "–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–∏—à–∏—Ç–µ /cancel",
                parse_mode='Markdown'
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: {e}")
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:100]}")
        
        context.user_data['adding_item'] = False
        return
    
    clinic = get_user_clinic(chat_id)
    has_clinic = bool(clinic)
    is_admin = clinic[3] == 'admin' if clinic else False
    
    if text == 'üè• –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–Ω–∏–∫—É':
        if has_clinic:
            await update.message.reply_text("‚ö†Ô∏è –í—ã —É–∂–µ –≤ –∫–ª–∏–Ω–∏–∫–µ! –ù–∞–ø–∏—à–∏—Ç–µ /leave —á—Ç–æ–±—ã –≤—ã–π—Ç–∏.")
            return
        
        await update.message.reply_text(
            "üè• *–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–ª–∏–Ω–∏–∫–∏*\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏:\n\n"
            "–ü—Ä–∏–º–µ—Ä: *–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è '–£–ª—ã–±–∫–∞'*\n\n"
            "‚ùå *–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–∏—à–∏—Ç–µ /cancel*",
            parse_mode='Markdown'
        )
        context.user_data['creating_clinic'] = True
    
    elif text == 'üîë –í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏':
        if has_clinic:
            await update.message.reply_text("‚ö†Ô∏è –í—ã —É–∂–µ –≤ –∫–ª–∏–Ω–∏–∫–µ! –ù–∞–ø–∏—à–∏—Ç–µ /leave —á—Ç–æ–±—ã –≤—ã–π—Ç–∏.")
            return
        
        await update.message.reply_text(
            "üîë *–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–ª–∏–Ω–∏–∫–µ*\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏ (6 —Å–∏–º–≤–æ–ª–æ–≤):\n\n"
            "–ü—Ä–∏–º–µ—Ä: `A1B2C3`\n\n"
            "–ö–æ–¥ –≤–∞–º –¥–æ–ª–∂–µ–Ω –¥–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª–∏–Ω–∏–∫–∏.\n\n"
            "‚ùå *–î–ª—è –æ—Ç–º–µ–Ω—ã –Ω–∞–ø–∏—à–∏—Ç–µ /cancel*",
            parse_mode='Markdown'
        )
        context.user_data['joining_clinic'] = True
    
    elif text in ['üì¶ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∫–ª–∞–¥', 'üì¶ –ù–∞—à —Å–∫–ª–∞–¥']:
        await show_warehouse(update, context)
    
    elif text == 'üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞':
        await search_items_start(update, context)
    
    elif text == '‚ûñ –°–ø–∏—Å–∞—Ç—å':
        await remove_item_start(update, context)
    
    elif text == 'üõí –ß—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å?':
        await show_to_order(update, context)
    
    elif text == '‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª':
        await add_item_start(update, context)
    
    elif text == 'üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏':
        await show_clinic_users(update, context)
    
    elif text == 'üî¢ –ú–æ–π –∫–æ–¥':
        if clinic and clinic[3] == 'admin':
            clinic_id, name, code, role = clinic
            await update.message.reply_text(
                f"üè• *{name}*\n"
                f"üî¢ *–ö–æ–¥ –∫–ª–∏–Ω–∏–∫–∏: {code}*\n\n"
                f"–î–∞–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.",
                parse_mode='Markdown'
            )
        else:
            await update.message.reply_text("‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç –∫–æ–¥!")
    
    elif text in ['üè• –ò–Ω—Ñ–æ –æ –∫–ª–∏–Ω–∏–∫–µ', 'üè• –ù–∞—à–∞ –∫–ª–∏–Ω–∏–∫–∞']:
        await show_clinic_info(update, context)
    
    elif text == 'üö™ –í—ã–π—Ç–∏':
        await leave_clinic(update, context)
    
    elif context.user_data.get('creating_clinic'):
        clinic_name = clean_input(text.strip())
        if len(clinic_name) < 2:
            await update.message.reply_text("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!")
            return
        
        chat_id = update.effective_chat.id
        user = update.effective_user
        
        conn = sqlite3.connect('sklad_complete.db')
        cursor = conn.cursor()
        
        code = generate_code()
        
        try:
            cursor.execute('BEGIN TRANSACTION')
            
            # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–Ω–∏–∫—É
            cursor.execute('''
                INSERT INTO clinics (name, code, admin_chat_id)
                VALUES (?, ?, ?)
            ''', (clinic_name, code, chat_id))
            
            clinic_id = cursor.lastrowid
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –∞–¥–º–∏–Ω–∞
            cursor.execute('''
                INSERT INTO clinic_users (clinic_id, chat_id, username, first_name, role)
                VALUES (?, ?, ?, ?, 'admin')
            ''', (clinic_id, chat_id, user.username, user.first_name))
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
            test_items = [
                (clinic_id, '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', '–ü–ª–æ–º–±–∏—Ä–æ–≤–æ—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª Spectra A2', 4, 2),
                (clinic_id, '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', '–û—Ä—Ç–æ—Ñ–æ—Å—Ñ–æ—Ä–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞', 1, 3),
                (clinic_id, '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', '–ü–µ—Ä—á–∞—Ç–∫–∏ M', 100, 50),
                (clinic_id, '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏', '–ú–∞—Å–∫–∏ 3-—Å–ª–æ–π–Ω—ã–µ', 50, 20),
                (clinic_id, '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', '–ù–∞–∫–æ–Ω–µ—á–Ω–∏–∫–∏ –¥–ª—è —Ç—É—Ä–±–∏–Ω—ã', 5, 2)
            ]
            cursor.executemany("INSERT INTO warehouse (clinic_id, category, name, quantity, min_quantity) VALUES (?, ?, ?, ?, ?)", test_items)
            
            conn.commit()
            
            await update.message.reply_text(
                f"‚úÖ *–ö–ª–∏–Ω–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!*\n\n"
                f"üè• –ù–∞–∑–≤–∞–Ω–∏–µ: {clinic_name}\n"
                f"üî¢ *–ö–û–î –ö–õ–ò–ù–ò–ö–ò: {code}*\n\n"
                f"‚ö†Ô∏è *–°–û–•–†–ê–ù–ò–¢–ï –≠–¢–û–¢ –ö–û–î!*\n\n"
                f"–†–∞–∑–¥–∞–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:\n"
                f"1. –û–Ω–∏ –ø–∏—à—É—Ç –±–æ—Ç—É /start\n"
                f"2. –í—ã–±–∏—Ä–∞—é—Ç '–í–≤–µ—Å—Ç–∏ –∫–æ–¥ –∫–ª–∏–Ω–∏–∫–∏'\n"
                f"3. –í–≤–æ–¥—è—Ç –∫–æ–¥: {code}\n\n"
                f"–¢–µ–ø–µ—Ä—å –≤—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª–∏–Ω–∏–∫–∏.",
                reply_markup=get_main_keyboard(True, True),
                parse_mode='Markdown'
            )
            
        except sqlite3.IntegrityError:
            conn.rollback()
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: —Ç–∞–∫–æ–π –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        except Exception as e:
            conn.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–Ω–∏–∫–∏: {e}")
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–Ω–∏–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        finally:
            conn.close()
        
        context.user_data['creating_clinic'] = False
    
    elif context.user_data.get('joining_clinic'):
        # –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–ª–∏–Ω–∏–∫–µ
        code = clean_input(text.strip().upper(), max_length=6)
        chat_id = update.effective_chat.id
        user = update.effective_user
        
        conn = sqlite3.connect('sklad_complete.db')
        cursor = conn.cursor()
        
        try:
            cursor.execute('SELECT id, name FROM clinics WHERE code = ?', (code,))
            clinic = cursor.fetchone()
            
            if clinic:
                clinic_id, clinic_name = clinic
                
                cursor.execute('SELECT * FROM clinic_users WHERE clinic_id = ? AND chat_id = ?', (clinic_id, chat_id))
                if cursor.fetchone():
                    await update.message.reply_text("‚ö†Ô∏è –í—ã —É–∂–µ –≤ —ç—Ç–æ–π –∫–ª–∏–Ω–∏–∫–µ!")
                else:
                    cursor.execute('''
                        INSERT INTO clinic_users (clinic_id, chat_id, username, first_name, role)
                        VALUES (?, ?, ?, ?, 'user')
                    ''', (clinic_id, chat_id, user.username, user.first_name))
                    
                    conn.commit()
                    
                    await update.message.reply_text(
                        f"‚úÖ *–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å!*\n\n"
                        f"üè• –ö–ª–∏–Ω–∏–∫–∞: {clinic_name}\n"
                        f"üë§ –í–∞—à–∞ —Ä–æ–ª—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n\n"
                        f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –æ–±—â–∏–π —Å–∫–ª–∞–¥.",
                        reply_markup=get_main_keyboard(True, False),
                        parse_mode='Markdown'
                    )
            else:
                await update.message.reply_text("‚ùå *–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω!*\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.", parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –∫ –∫–ª–∏–Ω–∏–∫–µ: {e}")
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        finally:
            conn.close()
        
        context.user_data['joining_clinic'] = False
    
    else:
        await update.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é üì±",
            reply_markup=get_main_keyboard(has_clinic, is_admin)
        )

# ========== –ó–ê–ü–£–°–ö ==========
async def main():
    app = Application.builder().token(TOKEN).build()
    
    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("leave", leave_clinic))
    app.add_handler(CommandHandler("exit", leave_clinic))
    app.add_handler(CommandHandler("cancel", cancel_operation))
    app.add_handler(CommandHandler("help", start))
    
    # Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    app.add_handler(CallbackQueryHandler(handle_category, pattern='^cat_'))
    app.add_handler(CallbackQueryHandler(handle_remove_category, pattern='^remove_cat_'))
    app.add_handler(CallbackQueryHandler(execute_remove, pattern='^do_remove_'))
    
    # Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
    app.add_handler(CallbackQueryHandler(handle_search_item, pattern='^search_item_'))
    app.add_handler(CallbackQueryHandler(remove_from_search, pattern='^remove_from_search_'))
    app.add_handler(CallbackQueryHandler(handle_search_navigation, pattern='^new_search_'))
    app.add_handler(CallbackQueryHandler(handle_search_navigation, pattern='^back_menu_'))
    
    # –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    print("=" * 60)
    print("ü§ñ –ë–û–¢ '–°–ö–õ–ê–î–°–¢–û–ú' - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø!")
    print("‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –ó–ê–ö–†–´–¢–´")
    print("‚úÖ –û–®–ò–ë–ö–ò: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π")
    print("‚úÖ –ë–ê–ó–ê –î–ê–ù–ù–´–•: –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã")
    print("=" * 60)
    print("üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:")
    print("1. SQL-–∏–Ω—ä–µ–∫—Ü–∏—è –≤ –ø–æ–∏—Å–∫–µ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")
    print("2. –û—à–∏–±–∫–∞ –≤ handle_remove_category - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")
    print("3. –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ - –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    print("4. Callback –ø–∞—Ç—Ç–µ—Ä–Ω—ã - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")
    print("5. –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤ - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞")
    print("=" * 60)
    print("üì± –ö–û–ú–ê–ù–î–´:")
    print("/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É")
    print("/leave - –í—ã–π—Ç–∏ –∏–∑ –∫–ª–∏–Ω–∏–∫–∏")
    print("/cancel - –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏")
    print("/help - –ü–æ–º–æ—â—å")
    print("=" * 60)
    print("‚ö†Ô∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π —Ç–æ–∫–µ–Ω –≤ —Å—Ç—Ä–æ–∫—É TOKEN!")
    print("=" * 60)
    
    try:
        await app.run_polling()
    except Exception as e:
        logger.error(f"–ë–æ—Ç —É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π: {e}")
        print(f"‚ùå –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏: {e}")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    asyncio.run(main())
